@using MediatR
@using MegaMind.Application.Stories.Queries
@using MegaMind.Application.Choices.Utilities
@using MegaMind.WebUI.UIComponents
@inject IMediator _mediator
@inject NavigationManager NavigationManager

<h1>@model.Text</h1>
<hr />
@foreach (var choice in model.Choices)
{
    <Button Text="@choice.Text" OnClickCallback="(async () => await GetConsequences())"></Button>
}
<Button Text="Ask a Subject Matter Expert" Disabled="true"></Button>
@FundsRemaining.ToString("C")
@ClientHappinessPercentage%

@code
{
    StoryViewModel model = new StoryViewModel();

    const int MaximumFundsRemaining = 1_000_000;
    int FundsRemaining;
    int ClientHappinessPercentage = 100;

    protected override async Task OnInitializedAsync()
    {
        model = await _mediator.Send(new GetStoryQuery(1));

        FundsRemaining = MaximumFundsRemaining;
    }

    private async Task GetConsequences()
    {
        CalculateChoiceFailure();
        if (IsGameOver())
        {
            NavigationManager.NavigateTo("GameOver");
        }
        else
        {
            model = await _mediator.Send(new GetStoryQuery(model.Id + 1));
        }
    }

    private void CalculateChoiceFailure()
    {
        ClientHappinessPercentage -= ChoiceFailureUtilities.CalculateHappinessFailure(ClientHappinessPercentage);

        FundsRemaining -= ChoiceFailureUtilities.CalculateFundsFailure(MaximumFundsRemaining);

        StateHasChanged();
    }

    private bool IsGameOver()
    {
        return FundsRemaining <= 0 || ClientHappinessPercentage <= 0;
    }
}
